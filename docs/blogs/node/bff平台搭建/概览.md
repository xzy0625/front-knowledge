# bff平台搭建

## cos

cos分路径存储。通过 应用 / 用户id / 文件名

corn定时脚本，定时删除14天前的文件和db数据

## 配置

使用七彩石作为配置，不同环境拉取不同的配置。例如数据库密码/账号等就是从配置中拉取。

## 路径

分为两个路径，一个是公司内部用，一个是外部用。是同一个服务，但是是通过不同的域名 + 路径访问的。一个是外部域名，一个是内部域名

## 部署

1. 流水线CI/CD拉取代码，打包后生成打包产物
2. 将打包打包成镜像，并把镜像放到镜像仓库。
3. 将镜像发布到腾讯云，并且会自动运行镜像，然后就会执行`npm run`命令。
4. 新增一个名字服务，将机器`ip`添加到名字服务里面
5. 通过统一接入服务，上述名字服务接入到指定域名的路径

### 顺便提一下前端部署

1. 流水线CI/CD拉取代码，打包后生成打包产物。js/css上传到CDN
2. 将打包打包成一个带有Nginx环境的镜像，使用的是Nginx+Node镜像(FROM mirrors.tencent.com/ams_public/tlinux2.2-ams-nodejs:16.13.1)。并把镜像放到镜像仓库。
3. 将镜像发布到腾讯云，并且会自动运行镜像，然后启动`Nginx`，使用项目中的`nginx`文件进行代理。
4. 新增一个名字服务，将机器`ip`添加到名字服务里面
5. 通过统一接入服务，上述名字服务接入到指定域名的路径

## IAS

IAS 一站式智能接入服务，不仅包括基础的 http/https 转发和负载均衡的原子能力，还包括多集群智能调度和网络传输协议优化等

目的是为业务/客户提供"一键式"的整套接入能力、更可靠服务能力和更好的网络接入性能

作为通用接入层给用户提供安全快捷的流量分发服务，访问流量经由 IAS可以自动转发到IDC、云上TKE等，扩展系统的服务能力并消除单点故障.

整合了安全扫描、安全防护、容灾、调度等能力 为用户提供便捷的业务流量接入体验

| **能力**                                                | **HTTP协议(CLB)**                                            |      |
| :------------------------------------------------------ | :----------------------------------------------------------- | ---- |
| 转发能力                                                | 柔性                                                         |      |
| 路由灰度                                                | 可通过自定义配置实现按条件灰度                               |      |
| 0RTT                                                    | QUIC下支持                                                   |      |
| 多通道                                                  | QUIC下支持                                                   |      |
| 长连接                                                  | HTTP2、 QUIC                                                 |      |
| 后端协议支持                                            | HTTP/HTTPS                                                   |      |
| 支持名字服务                                            | 北极星、CL5、TAF、IP列表                                     |      |
| 安全                                                    | 支持TLS1.0(不建议)、TLS1.1(不建议)、TLS1.2、TLS1.3           |      |
| 证书托管 - 证书自动续期                                 |                                                              |      |
| WAF能力:自动接入洞犀安全扫描、门神安全防护              |                                                              |      |
| 白名单功能：IP白名单                                    |                                                              |      |
| 合规:备案提醒、特殊地区封禁                             |                                                              |      |
| 防突发:限速或者迁移到一个泄洪集群，该集群与其他业务隔离 |                                                              |      |
| 容灾                                                    | 多地部署，默认：华东（上海/南京）、华南（广州/深圳）、华北（天津/北京）、香港/新加坡等，另外支持EC机房（二线城市机房，价格便宜，就近接入） |      |
| 自动屏蔽异常VIP                                         |                                                              |      |
| 外网IP调度                                              | 就近调度                                                     |      |
| 自动发现和屏蔽异常VIP                                   |                                                              |      |
| 监控                                                    | 1）IAS域名-指标监控：维度:域名、二级路径、主被调、返回码等指标:各状态码、连接成功率等2）IAS域名拨测监控 - 证书拨测 |      |

## 北极星

北极星是统一名字服务组件，名字服务用于解决远程调用（RPC）的服务注册发现、动态路由、负载均衡和容错问题，在分布式和微服务架构中至关重要。

- 由于不同系统上的数据不通，不同系统上的服务难以互相调用
- 不同系统的功能特性不一致，功能特性和易用性落后于业界水平
